extends Node2D

var editing: bool = false
var title: String = "Three Red Hearts"

var fall_delay: float = 4.8

var key_output = [[], [], [], []]

var info: Dictionary = {
	"Rhythm Hell": {
		"timings":  "[[4.75],[5.25],[5.75],[6.25]]",
		"music": load("res://RhythmHell.wav")
	},

	"Three Red Hearts": {
		# "timings":  "[[16.7], [16.6], [5.66, 5.8, 6.33, 7.1, 7.87, 8.66, 9.4, 10.0, 10.9, 11.6, 11.8, 12.33, 13.1, 13.9, 14.6, 15.4, 16.1, 16.5], [5.4, 9.0, 11.4, 12.0, 12.75, 12.9, 13.33, 13.7, 14.0, 14.45, 14.8, 15.0, 15.75, 15.9, 16.33]]",
		"timings":  "[[16.7], [16.6], [5.4, 9.0, 11.4, 12.0, 12.75, 12.9, 13.33, 13.7, 14.0, 14.45, 14.8, 15.0, 15.75, 15.9, 16.33], [5.73823118209839, 5.88916110992432, 6.48126983642578, 7.18947839736938, 7.95573711395264, 8.72199535369873, 9.45342445373535, 10.1500225067139, 10.9395008087158, 11.7057600021362, 11.8799095153809, 12.4836282730103, 13.2847166061401, 14.0161447525024, 14.7359638214111, 15.4673919677734, 16.2568702697754, 17.0231285095215, 17.7429485321045, 17.8706569671631, 18.4743766784668, 19.217414855957, 19.9488430023193, 20.6454429626465, 21.5277996063232, 22.1895694732666, 22.9558277130127, 23.7220859527588, 23.8962364196777, 24.4883441925049, 25.3474826812744, 25.9628124237061, 26.752290725708, 27.5185489654541, 28.1803169250488, 29.0278453826904, 29.6780052185059, 30.444263458252, 31.1873016357422, 31.3846702575684, 31.9187297821045, 32.7082099914551, 33.4744682312012, 34.1478462219238, 34.9605445861816, 35.6919746398926, 35.842903137207, 36.4814529418945, 36.632381439209, 37.1664390563965, 37.9559173583984, 38.0952377319336, 38.7221755981445, 39.4652137756348, 39.6393661499023, 40.2082557678223, 40.9396820068359, 41.1138305664062, 41.705940246582, 42.4721984863281, 42.6231307983398, 43.1804084777832, 43.9466667175293, 44.0975952148438, 44.7129249572754, 45.4443550109863, 45.6068916320801, 46.1873931884766, 46.9536514282227, 47.127799987793, 47.7199096679688, 48.462947845459, 48.6138763427734, 49.1943778991699, 49.9374160766602, 50.1347846984863, 50.6920623779297, 51.5163726806641, 51.6905212402344, 52.1781387329102, 53.0140571594238, 53.1882095336914, 53.7106590270996, 54.488525390625, 54.6278457641602, 55.2083435058594, 56.0210418701172, 56.148754119873, 56.7060317993164, 57.4722900390625, 57.6464385986328, 58.1921081542969, 59.0512466430664, 59.2021751403809, 59.7362365722656, 60.4328346252441, 60.5837631225586, 61.1874847412109, 62.011791229248, 62.2091598510742, 62.6967811584473, 63.4398193359375, 63.590747833252, 64.194465637207, 64.9839477539062, 65.6573257446289, 66.487434387207, 67.1782302856445, 67.921272277832, 68.6294784545898, 68.8036270141602, 69.5931091308594, 70.2084350585938, 70.997917175293, 71.6828994750977, 72.4259414672852, 73.1457595825195, 73.9352416992188, 74.6666641235352, 74.8408126831055, 75.479362487793, 76.1411361694336, 76.9538345336914, 77.6968688964844, 78.4399108886719, 79.1249008178711, 79.9724273681641, 80.703857421875, 80.8547821044922, 81.446891784668, 82.201545715332, 82.9213638305664, 83.6876220703125, 84.4538803100586, 85.185302734375, 85.9515609741211, 86.7410430908203, 86.891975402832, 87.5073013305664, 88.2155075073242, 88.9817657470703, 89.7712478637695, 90.4562377929688, 91.1992721557617, 91.9074859619141, 92.6737442016602, 93.4632186889648, 94.2062606811523, 94.9725189208984, 95.727165222168, 96.5282516479492, 97.1900253295898, 97.9794998168945, 98.7109298706055]]",
		"music": load("res://[Boxing] Three Red Hearts - Box Jump.ogg")
	},

}

func _ready():
	$Player.stream = info.get(title).get("music")
	$Player.play()

	if editing:
		Manager.listener_press.connect(listener_press)
	else:
		var timings = info.get(title).get("timings")
		var timings_array = str_to_var(timings)

		var index: int = 0

		for key in timings_array:
			var key_name: String = ""

			match index:
				0:
					key_name = "left"
				1:
					key_name = "up"
				2:
					key_name = "down"
				3:
					key_name = "right"

			for delay in key:
				spawn_note(key_name, delay - fall_delay)
			
			index += 1

func _input(event):
	if Input.is_key_pressed(KEY_ESCAPE):
		print(key_output)

func listener_press(key: String, index: int):
	# print(index, " " + str($Player.get_playback_position()))
	# key_output[index].append($Player.get_playback_position() - fall_delay)
	key_output[index].append($Player.get_playback_position())

func spawn_note(key: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Manager.spawn_note.emit(key)


func _on_player_finished() -> void:
	print(key_output)
